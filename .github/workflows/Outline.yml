name: Convert LaTeX to HTML
on:
  push:
    branches:
      - main

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Outline repository
        uses: actions/checkout@v3
        with:
          repository: tomoto0/Outline
          path: Outline

      - name: Checkout tomoto0.github.io repository
        uses: actions/checkout@v3
        with:
          repository: tomoto0/tomoto0.github.io
          path: tomoto0.github.io

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install TeX Live
        run: |
          wget https://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -xzf install-tl-unx.tar.gz
          INSTALL_TL_DIR=$(find . -maxdepth 1 -type d -name "install-tl-*" | head -n 1)
          if [ -z "$INSTALL_TL_DIR" ]; then
            echo "TeX Live installation directory not found"
            exit 1
          fi
          cd "$INSTALL_TL_DIR"
          sudo ./install-tl --profile=../../Outline/texlive.profile

      - name: Find TeX Live path
        id: texlive_path
        run: |
          echo "Which pdflatex:"
          PDFLATEX_PATH=$(which pdflatex) || echo "pdflatex not found"
          
          echo "Which tlmgr:"
          TLMGR_PATH=$(which tlmgr) || echo "tlmgr not found"
          
          echo "TEXMFROOT:"
          TEXMFROOT=$(kpsewhich -var-value TEXMFROOT) || echo "TEXMFROOT not found"
          
          echo "TEXMFDIST:"
          TEXMFDIST=$(kpsewhich -var-value TEXMFDIST) || echo "TEXMFDIST not found"
          
          echo "Searching for texlive directory:"
          TEXLIVE_DIR=$(find /usr/local -type d -name "texlive" 2>/dev/null | head -n 1) || echo "texlive directory not found"
          
          if [ -n "$PDFLATEX_PATH" ]; then
            TEXLIVE_BIN_DIR=$(dirname "$PDFLATEX_PATH")
            echo "TEXLIVE_BIN_DIR=$TEXLIVE_BIN_DIR" >> $GITHUB_OUTPUT
          elif [ -n "$TEXLIVE_DIR" ]; then
            TEXLIVE_BIN_DIR=$(find "$TEXLIVE_DIR" -type d -name "bin" | head -n 1)
            echo "TEXLIVE_BIN_DIR=$TEXLIVE_BIN_DIR" >> $GITHUB_OUTPUT
          else
            echo "Unable to find TeX Live binary directory"
            exit 1
          fi

      - name: Update PATH
        run: |
          echo "${{ steps.texlive_path.outputs.TEXLIVE_BIN_DIR }}" >> $GITHUB_PATH
          echo "export PATH=$PATH:${{ steps.texlive_path.outputs.TEXLIVE_BIN_DIR }}" >> $GITHUB_ENV
          echo "export MANPATH=$MANPATH:$(dirname ${{ steps.texlive_path.outputs.TEXLIVE_BIN_DIR }})/texmf-dist/doc/man" >> $GITHUB_ENV
          echo "export INFOPATH=$INFOPATH:$(dirname ${{ steps.texlive_path.outputs.TEXLIVE_BIN_DIR }})/texmf-dist/doc/info" >> $GITHUB_ENV
          source $GITHUB_ENV

      - name: Install additional TeX Live packages
        run: |
          sudo env "PATH=$PATH" tlmgr update --self
          sudo env "PATH=$PATH" tlmgr install pgfplots caption geometry subcaption

      - name: Convert LaTeX to HTML
        run: |
          pandoc ./Outline/Outline.tex -o outline_temp.html \
            --standalone \
            --mathjax \
            --css=https://latex.vercel.app/style.css \
            --highlight-style=pygments \
            --lua-filter=./Outline/custom-filter.lua \
            --extract-media=extracted-media

      - name: Process LaTeX figures and tables
        run: |
          mkdir -p ./extracted-media
          for file in ./Outline/*.tex; do
            if [[ "$file" != "./Outline/Outline.tex" ]]; then
              filename=$(basename -- "$file")
              filename="${filename%.*}"
              pdflatex -output-directory=./extracted-media -interaction=nonstopmode "$file"
              if [ -f "./extracted-media/${filename}.pdf" ]; then
                pdftocairo -svg "./extracted-media/${filename}.pdf" "./extracted-media/${filename}.svg"
              fi
            fi
          done

      - name: Add additional CSS and scripts
        run: |
          title=$(grep -m 1 '\\title{' ./Outline/Outline.tex | sed 's/\\title{$$.*$$}/\1/')
          cat <<EOF > ./tomoto0.github.io/outline.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>$title</title>
            <link rel="stylesheet" href="https://latex.vercel.app/style.css">
            <link rel="stylesheet" href="https://latex.vercel.app/prism/prism.css">
            <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>
            <style>
              .download-container {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px 0;
              }
              .download-button {
                background-color: #f1f1f1;
                color: #000;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
              }
              .download-button:hover {
                background-color: #ddd;
              }
              figure {
                text-align: center;
                margin: 20px 0;
              }
              figure img {
                max-width: 100%;
                height: auto;
              }
              figcaption {
                margin-top: 10px;
                font-style: italic;
              }
            </style>
          </head>
          <body class="latex-dark-auto">
            <h1>$title</h1>
            <div class="download-container">
              <a href="Outline (9).pdf" download>
                <button class="download-button">
                  <i class="fa fa-download"></i> Download PDF
                </button>
              </a>
            </div>
          EOF
          
          # Remove the title from the body and add the rest of the content
          sed '1,/<body/d' outline_temp.html | sed '/<h1 class="title">/,/<\/h1>/d' >> ./tomoto0.github.io/outline.html
          
          # Replace figure references with actual SVG images
          sed -i 's/<img src="$$.*$$\.pdf" /<img src="\1.svg" /g' ./tomoto0.github.io/outline.html
          
          cat <<'EOF' >> ./tomoto0.github.io/outline.html
          <script>
            MathJax = {
              tex: {
                inlineMath: [['$', '$'],],
              },
            };
          </script>
          </body>
          </html>
          EOF
          
          rm outline_temp.html

      - name: Copy extracted media
        run: |
          cp -R ./extracted-media ./tomoto0.github.io/

      - name: Commit and push changes
        run: |
          cd ./tomoto0.github.io
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add outline.html extracted-media
          git commit -m 'Convert LaTeX to HTML with improved styling and figures'
          git push
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_FOR_OUTLINE_REPO }}
